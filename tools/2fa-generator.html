<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>2Fa Generator</title>
  <link rel="stylesheet" href="../style.css" />
  <style>
    /* Tool Container */
    .tool-card {
      max-width: 420px;
      margin: 40px auto;
      padding: 20px;
      background: #fff;
      border-radius: 15px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      text-align: center;
    }

    .tool-card label {
      display: block;
      font-weight: bold;
      margin-bottom: 6px;
    }

    .tool-card input {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 14px;
    }

    .tool-buttons {
      display: flex;
      gap: 8px;
      margin-top: 10px;
      flex-wrap: wrap;
    }

    .tool-buttons button {
      flex: 1;
      padding: 8px 12px;
      border: none;
      border-radius: 8px;
      background: #4CAF50;
      color: #fff;
      font-size: 14px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .tool-buttons button:hover {
      background: #43a047;
    }

    #totp-code {
      font-size: 2rem;
      font-weight: bold;
      margin-top: 15px;
    }

    .progress-container {
      height: 6px;
      background: #eee;
      border-radius: 999px;
      margin-top: 8px;
      overflow: hidden;
    }

    .progress-bar {
      height: 100%;
      width: 0%;
      background: #4CAF50;
      transition: width 0.5s;
    }

    #totp-qr-container img {
      border: 1px solid #ddd;
      padding: 4px;
      border-radius: 8px;
      background: #fafafa;
    }
  </style>
</head>
<body>
  <header>
    <h1>2Fa Generator</h1>
    <nav><a href="../index.html">← Home</a></nav>
  </header>

  <main>
    <div class="tool-card">
      <!-- 2FA Tool -->
      <label for="totp-secret">Secret (Base32)</label>
      <input id="totp-secret" type="text" placeholder="JBSWY3DPEHPK3PXP" />

      <div class="tool-buttons">
        <button id="totp-gen">Random Secret</button>
        <button id="totp-qr">Show QR</button>
        <button id="totp-copy">Copy Code</button>
      </div>

      <div>
        <div id="totp-code">------</div>
        <div>Expires in <span id="totp-expires">--</span> sec</div>
        <div class="progress-container">
          <div id="totp-bar" class="progress-bar"></div>
        </div>
      </div>

      <div id="totp-qr-container" style="margin-top:12px;"></div>
    </div>
  </main>

  <footer>
    Developed by <a href="https://instagram.com/nurulnc100" target="_blank">Nurul Nc</a>
  </footer>

  <script>
  (function(){
    const BASE32_ALPHABET = "ABCDEFGHIJKLMNOPQRSTUVWXYZ234567";
    function base32Decode(str){
      str = (str||"").replace(/\s+/g,'').replace(/=+$/,'').toUpperCase();
      let bits=0,value=0, out=[];
      for (let i=0;i<str.length;i++){
        const idx = BASE32_ALPHABET.indexOf(str[i]);
        if (idx === -1) continue;
        value = (value << 5) | idx;
        bits += 5;
        if (bits >= 8){
          out.push((value >>> (bits - 8)) & 0xFF);
          bits -= 8;
        }
      }
      return new Uint8Array(out);
    }
    function base32Encode(bytes){
      let bits=0,value=0,out="";
      for (let i=0;i<bytes.length;i++){
        value = (value << 8) | bytes[i];
        bits += 8;
        while(bits >= 5){
          out += BASE32_ALPHABET[(value >>> (bits - 5)) & 31];
          bits -= 5;
        }
      }
      if (bits > 0) out += BASE32_ALPHABET[(value << (5 - bits)) & 31];
      return out;
    }

    async function totp(secretBase32, digits=6, period=30){
      const keyBytes = base32Decode(secretBase32);
      if (!keyBytes || keyBytes.length === 0) throw new Error("Invalid base32 secret");
      const cryptoKey = await crypto.subtle.importKey("raw", keyBytes, {name:"HMAC", hash:"SHA-1"}, false, ["sign"]);
      const counter = Math.floor(Date.now()/1000/period);
      const buf = new ArrayBuffer(8);
      const dv = new DataView(buf);
      dv.setUint32(4, counter);
      const sig = new Uint8Array(await crypto.subtle.sign("HMAC", cryptoKey, buf));
      const offset = sig[sig.length - 1] & 0x0f;
      const binary = ((sig[offset] & 0x7f) << 24) |
                     ((sig[offset+1] & 0xff) << 16) |
                     ((sig[offset+2] & 0xff) << 8) |
                     (sig[offset+3] & 0xff);
      return (binary % (10 ** digits)).toString().padStart(digits, "0");
    }

    const secretEl = document.getElementById("totp-secret");
    const codeEl = document.getElementById("totp-code");
    const expiresEl = document.getElementById("totp-expires");
    const barEl = document.getElementById("totp-bar");
    const qrContainer = document.getElementById("totp-qr-container");
    const btnGen = document.getElementById("totp-gen");
    const btnQR = document.getElementById("totp-qr");
    const btnCopy = document.getElementById("totp-copy");

    let intervalId = null;
    const PERIOD = 30;

    async function updateOnce(){
      const secret = (secretEl.value||"").trim();
      if (!secret){
        codeEl.textContent = "------";
        expiresEl.textContent = "--";
        barEl.style.width = "0%";
        return;
      }
      const now = Math.floor(Date.now()/1000);
      const elapsed = now % PERIOD;
      const remaining = PERIOD - elapsed;
      expiresEl.textContent = remaining;
      barEl.style.width = ((elapsed / PERIOD) * 100) + "%";
      try {
        const otp = await totp(secret, 6, PERIOD);
        codeEl.textContent = otp;
      } catch {
        codeEl.textContent = "Error";
      }
    }

    function startLoop(){
      if (intervalId) return;
      updateOnce();
      intervalId = setInterval(updateOnce, 1000);
    }

    btnGen.addEventListener("click", ()=>{
      const bytes = new Uint8Array(20);
      crypto.getRandomValues(bytes);
      secretEl.value = base32Encode(bytes);
      qrContainer.innerHTML = "";
      updateOnce();
    });

    btnQR.addEventListener("click", ()=>{
      const secret = (secretEl.value||"").trim();
      if (!secret){
        qrContainer.innerHTML = "<div style='color:red'>Please provide a Base32 secret first</div>";
        return;
      }
      const label = encodeURIComponent("MyService:User");
      const issuer = encodeURIComponent("MyService");
      const otpauth = `otpauth://totp/${label}?secret=${secret}&issuer=${issuer}`;
      const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=220x220&data=${encodeURIComponent(otpauth)}`;
      qrContainer.innerHTML = `<img src="${qrUrl}" alt="QR code"><div style="font-size:12px;margin-top:6px;color:#555">Scan with Google Authenticator</div>`;
    });

    btnCopy.addEventListener("click", async ()=>{
      const text = codeEl.textContent.trim();
      if (!text || text === "------" || text === "Error") return;
      try {
        await navigator.clipboard.writeText(text);
        const prev = btnCopy.textContent;
        btnCopy.textContent = "Copied!";
        setTimeout(()=> btnCopy.textContent = prev, 1400);
      } catch {
        alert("Copy failed — please copy manually: " + text);
      }
    });

    startLoop();
  })();
  </script>
</body>
</html>
